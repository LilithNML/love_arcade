<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tetris Pro | Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg: #02040a;
            --panel: rgba(20, 25, 40, 0.9);
            --accent: #facc15;
            --text: #ffffff;
            --border: rgba(255, 255, 255, 0.15);
        }

        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            background-image: radial-gradient(circle at 50% 100%, #1e1b4b 0%, #000 60%);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            height: 100dvh; width: 100vw;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- 1. HEADER --- */
        header {
            height: 50px; padding: 0 15px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.3); z-index: 100;
        }

        .btn-ui {
            background: rgba(255,255,255,0.08); border: 1px solid var(--border);
            color: white; padding: 6px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-ui:active { background: var(--accent); color: black; }

        .logo { font-weight: 900; font-size: 1.1rem; letter-spacing: 1px; }

        /* --- 2. STATS (ARRIBA) --- */
        .top-stats {
            display: flex; flex-direction: column; gap: 5px;
            padding: 10px; width: 100%; max-width: 500px; margin: 0 auto;
            flex-shrink: 0; z-index: 90;
        }

        .row-stats { display: flex; gap: 8px; justify-content: space-between; }

        .stat-box {
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 8px; padding: 4px 8px; text-align: center; flex: 1;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .label { font-size: 0.6rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; }
        .val { font-size: 1rem; font-weight: 800; color: #fff; line-height: 1; }
        .gold { color: var(--accent); text-shadow: 0 0 10px rgba(250, 204, 21, 0.4); }

        /* Next Piece Mini */
        .next-wrap {
            display: flex; align-items: center; justify-content: center;
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 8px; width: 50px; flex-shrink: 0;
        }
        #next-grid {
            width: 32px; height: 32px;
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 1px; align-content: center; justify-content: center;
        }
        .p-cell { width: 7px; height: 7px; border-radius: 1px; }

        /* --- 3. AREA DE JUEGO (CENTRO) --- */
        .game-zone {
            flex: 1; width: 100%;
            display: flex; justify-content: center; align-items: center;
            position: relative; overflow: hidden;
            padding: 10px;
        }

        .board-container {
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 4px; overflow: hidden;
            background: rgba(0,0,0,0.8);
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            /* Tama√±o fijado por JS */
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* Bot√≥n Pausa Flotante */
        #btn-pause {
            position: absolute; top: 10px; right: 10px; z-index: 80;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); cursor: pointer;
        }

        /* --- 4. CONTROLES --- */
        /* Capa Swipe */
        #touch-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; }

        /* Botones D-Pad */
        .dpad-overlay {
            position: absolute; bottom: 60px; left: 0; width: 100%;
            display: none; justify-content: space-between; padding: 0 20px;
            z-index: 50; pointer-events: none;
        }
        .dpad-overlay.show { display: flex; }
        
        .dpad-btn {
            width: 60px; height: 60px; background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 14px; color: white; display: flex; align-items: center; justify-content: center;
            pointer-events: auto; transition: 0.1s; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .dpad-btn:active { background: var(--accent); color: black; transform: scale(0.9); }
        .btn-rotate-big { width: 75px; height: 75px; border-radius: 50%; background: rgba(139, 92, 246, 0.25); border-color: #8b5cf6; }

        /* Toggle Button */
        #ctrl-toggle {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 30, 0.9); border-radius: 30px;
            display: flex; gap: 5px; padding: 4px; border: 1px solid var(--border);
            z-index: 60;
        }
        .mode-icon {
            width: 34px; height: 34px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #64748b; cursor: pointer; transition: 0.2s;
        }
        .mode-icon.active { background: var(--accent); color: black; }

        /* --- MODALES --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; justify-content: center; align-items: center;
            z-index: 200; backdrop-filter: blur(8px);
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.visible { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: #111827; border: 1px solid var(--border);
            padding: 30px; border-radius: 20px; text-align: center;
            width: 90%; max-width: 320px;
            box-shadow: 0 0 60px rgba(250, 204, 21, 0.15);
        }

        .btn-primary {
            background: var(--accent); color: black; border: none;
            width: 100%; padding: 14px; border-radius: 10px;
            font-weight: 800; font-size: 1.1rem; cursor: pointer;
            margin-top: 20px; text-transform: uppercase;
        }
        .btn-primary:active { transform: scale(0.96); }
        .btn-text {
            background: transparent; color: #94a3b8; border: none;
            margin-top: 15px; text-decoration: underline; cursor: pointer;
        }

        /* --- DRAWER --- */
        .drawer {
            position: fixed; top: 0; right: -100%; width: 100%; max-width: 300px;
            height: 100%; background: #02040a; z-index: 300;
            transition: right 0.3s ease; border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
        }
        .drawer.open { right: 0; }
        .ach-item { padding: 12px; border-bottom: 1px solid var(--border); opacity: 0.6; display: flex; align-items: center; gap: 10px; }
        .ach-item.unlocked { opacity: 1; border-left: 4px solid var(--success); background: rgba(16, 185, 129, 0.05); }
        
        /* FX */
        .flash { animation: flash 0.1s ease-out; }
        @keyframes flash { 0% { border-color: white; box-shadow: 0 0 30px white; } 100% { border-color: rgba(255,255,255,0.1); } }
        
        /* Toast */
        .toast {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: var(--success); color: black; padding: 8px 16px;
            border-radius: 20px; font-weight: 700; z-index: 500;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast.show { opacity: 1; }

    </style>
</head>
<body>

    <header>
        <button class="btn-ui" onclick="window.location.href='../index.html'">
            <i data-lucide="arrow-left" size="20"></i>
        </button>
        <div class="logo">TETRIS PRO</div>
        <div style="display:flex; gap:8px;">
            <button id="btn-sound" class="btn-ui"><i data-lucide="volume-2" size="20"></i></button>
            <button id="btn-ach" class="btn-ui"><i data-lucide="trophy" size="20" class="gold"></i></button>
        </div>
    </header>

    <div class="top-stats">
        <div class="row-stats">
            <div class="stat-box">
                <div class="label">Puntos</div>
                <div class="val gold" id="ui-score">0</div>
            </div>
            <div class="next-box">
                <div id="next-grid"></div>
            </div>
            <div class="stat-box">
                <div class="label">Nivel</div>
                <div class="val" id="ui-level">1</div>
            </div>
        </div>
        <div class="row-stats">
            <div class="stat-box">
                <div class="label">L√≠neas</div>
                <div class="val" id="ui-lines">0</div>
            </div>
            <div class="stat-box">
                <div class="label">R√©cord</div>
                <div class="val gold" id="ui-high-score">0</div>
            </div>
        </div>
    </div>

    <div class="game-zone" id="board-zone">
        <div class="board-container" id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
        <button id="btn-pause"><i data-lucide="pause" size="20"></i></button>
    </div>

    <div id="touch-layer"></div>

    <div id="dpad" class="dpad-overlay">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="dpad-btn" id="btn-left"><i data-lucide="chevron-left"></i></button>
            <button class="dpad-btn" id="btn-right"><i data-lucide="chevron-right"></i></button>
            <button class="dpad-btn" style="grid-column:span 2" id="btn-down"><i data-lucide="chevron-down"></i></button>
        </div>
        <button class="dpad-btn btn-rotate-big" id="btn-rotate"><i data-lucide="rotate-cw" size="32"></i></button>
    </div>

    <div id="ctrl-toggle">
        <div class="mode-icon active" id="mode-swipe"><i data-lucide="hand" size="18"></i></div>
        <div class="mode-icon" id="mode-dpad"><i data-lucide="gamepad-2" size="18"></i></div>
    </div>

    <div id="modal" class="modal visible">
        <div class="modal-content">
            <h2 id="modal-title" style="color:var(--accent); margin-bottom:10px;">TETRIS PRO</h2>
            <p id="modal-msg" style="color:#94a3b8; margin-bottom:20px;">¬°Juega y gana recompensas!</p>
            <button id="btn-main" class="btn-primary">JUGAR</button>
            <button id="btn-exit" class="btn-text" style="display:none">Salir al men√∫</button>
        </div>
    </div>

    <div id="drawer" class="drawer">
        <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">Logros</h3>
            <button class="btn-ui" id="btn-close-drawer"><i data-lucide="x"></i></button>
        </div>
        <div id="ach-list" style="overflow-y:auto; flex:1;"></div>
    </div>

    <div id="toast" class="toast">Notificaci√≥n</div>

    <script src="../js/app.js"></script>
    <script>
        /* CONFIG */
        const CONFIG = {
            COLS: 10, ROWS: 20, ASPECT: 0.5,
            COLORS: [null, '#22d3ee', '#3b82f6', '#f97316', '#facc15', '#4ade80', '#c084fc', '#f43f5e'],
            SHAPES: [[], [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]], [[2,0,0],[2,2,2],[0,0,0]], [[0,0,3],[3,3,3],[0,0,0]], [[4,4],[4,4]], [[0,5,5],[5,5,0],[0,0,0]], [[0,6,0],[6,6,6],[0,0,0]], [[7,7,0],[0,7,7],[0,0,0]]]
        };

        const Storage = {
            get(k, d) { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } },
            set(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} }
        };

        /* UI MANAGER */
        const UI = {
            els: {},
            init() {
                ['ui-score','ui-level','ui-lines','ui-high-score','next-grid','modal','modal-title','modal-msg','btn-main','btn-exit','drawer','ach-list','toast','btn-sound','dpad','mode-swipe','mode-dpad','canvas-frame','canvas','board-zone','btn-pause'].forEach(id => this.els[id] = document.getElementById(id));
                
                document.getElementById('btn-ach').onclick = () => this.toggleDrawer();
                document.getElementById('btn-close-drawer').onclick = () => this.toggleDrawer();
                this.els['btn-sound'].onclick = () => AudioSys.toggle();
                this.els['mode-swipe'].onclick = () => Input.setMode('swipe');
                this.els['mode-dpad'].onclick = () => Input.setMode('dpad');
                
                // Exit button
                this.els['btn-exit'].onclick = () => window.location.href = '../index.html';
            },
            update(s, l, li, hs) {
                this.els['ui-score'].innerText = s;
                this.els['ui-level'].innerText = l;
                this.els['ui-lines'].innerText = li;
                this.els['ui-high-score'].innerText = hs;
            },
            drawNext(m, c) {
                const con = this.els['next-grid']; con.innerHTML = '';
                con.style.gridTemplateColumns = `repeat(${m[0].length}, 1fr)`;
                m.forEach(r => r.forEach(v => {
                    const d = document.createElement('div'); d.className='p-cell';
                    if(v) { d.style.backgroundColor=c; d.style.boxShadow='inset 1px 1px rgba(255,255,255,0.5)'; }
                    con.appendChild(d);
                }));
            },
            modal(st, sc=0, cb) {
                const { modal, 'modal-title':t, 'modal-msg':m, 'btn-main':b, 'btn-exit':e } = this.els;
                modal.classList.add('visible');
                if(st==='start') { t.innerText="TETRIS PRO"; m.innerText="¬°Completa l√≠neas!"; b.innerText="JUGAR"; e.style.display='none'; }
                else if(st==='pause') { t.innerText="PAUSA"; m.innerText=""; b.innerText="CONTINUAR"; e.style.display='block'; }
                else { t.innerText="GAME OVER"; m.innerHTML=`Puntos: <strong class="gold">${sc}</strong>`; b.innerText="REINTENTAR"; e.style.display='block'; }
                
                // Limpiar listeners anteriores para evitar duplicados
                const newBtn = b.cloneNode(true);
                b.parentNode.replaceChild(newBtn, b);
                this.els['btn-main'] = newBtn;
                
                newBtn.onclick = () => { modal.classList.remove('visible'); if(cb) cb(); };
            },
            toggleDrawer() { this.els.drawer.classList.toggle('open'); },
            toast(msg, c) {
                const t = this.els.toast; t.innerHTML=`üèÜ ${msg} <span class="gold">+${c}</span>`;
                t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000);
            },
            resize() {
                const zone = this.els['board-zone'];
                const frame = document.getElementById('canvas-container');
                const cv = this.els.canvas;
                
                // Calcular tama√±o: Altura - Padding
                const maxH = zone.clientHeight - 10;
                const maxW = zone.clientWidth - 10;
                
                let h = maxH;
                let w = h * CONFIG.ASPECT;
                
                if (w > maxW) { w = maxW; h = w / CONFIG.ASPECT; }
                
                frame.style.width = `${w}px`; frame.style.height = `${h}px`;
                
                const dpr = window.devicePixelRatio || 1;
                cv.width = w * dpr; cv.height = h * dpr;
                
                return { ctx: cv.getContext('2d'), dpr, bs: w / CONFIG.COLS };
            }
        };

        /* AUDIO SYSTEM */
        const AudioSys = {
            ctx: null, muted: false,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if(this.ctx.state==='suspended') this.ctx.resume(); },
            play(t) {
                if(this.muted || !this.ctx) return;
                const o=this.ctx.createOscillator(), g=this.ctx.createGain(), now=this.ctx.currentTime;
                o.connect(g); g.connect(this.ctx.destination);
                
                if(t==='move') { o.frequency.value=200; g.gain.value=0.03; o.start(now); o.stop(now+0.05); }
                else if(t==='drop') { o.type='square'; o.frequency.exponentialRampToValueAtTime(50,now+0.1); g.gain.value=0.08; o.start(now); o.stop(now+0.1); }
                else if(t==='clear') { o.type='triangle'; o.frequency.linearRampToValueAtTime(800,now+0.2); g.gain.value=0.1; o.start(now); o.stop(now+0.3); }
                else if(t==='over') { o.type='sawtooth'; o.frequency.linearRampToValueAtTime(50,now+1); g.gain.value=0.15; o.start(now); o.stop(now+1); }
            },
            toggle() {
                this.muted = !this.muted;
                document.getElementById('btn-sound').innerHTML = this.muted ? '<i data-lucide="volume-x" size="20"></i>' : '<i data-lucide="volume-2" size="20"></i>';
                lucide.createIcons(); this.init();
            }
        };

        /* LOGROS */
        const Achievements = {
            list: [{id:'start',t:'Novato',c:200},{id:'score1k',t:'1k Puntos',c:300},{id:'tetris',t:'¬°TETRIS!',c:400},{id:'lines10',t:'10 L√≠neas',c:400},{id:'lvl5',t:'Nivel 5',c:500},{id:'score5k',t:'5k Puntos',c:800}],
            data: { unlocked:[], stats:{games:0} },
            init() { this.data = Storage.get('tetris_v7', {unlocked:[], stats:{games:0}}); this.render(); },
            notify(e,v) {
                if(e==='start') { this.data.stats.games++; this.unlock('start'); }
                if(e==='score' && v>=1000) this.unlock('score1k');
                if(e==='score' && v>=5000) this.unlock('score5k');
                if(e==='lines' && v>=10) this.unlock('lines10');
                if(e==='tetris') this.unlock('tetris');
                if(e==='level' && v>=5) this.unlock('lvl5');
                Storage.set('tetris_v7', this.data);
            },
            unlock(id) {
                if(this.data.unlocked.includes(id)) return;
                this.data.unlocked.push(id);
                const i = this.list.find(x=>x.id===id);
                if(i) { UI.toast(i.t, i.c); if(window.GameCenter) window.GameCenter.completeLevel('tetris',id,i.c); this.render(); }
            },
            render() {
                UI.els['ach-list'].innerHTML = this.list.map(a => {
                    const ok = this.data.unlocked.includes(a.id);
                    return `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid rgba(255,255,255,0.1); opacity:${ok?1:0.5}; ${ok?'background:rgba(16,185,129,0.1); border-left:3px solid #10b981':''}">
                        <span style="font-size:0.9rem; font-weight:700;">${a.t}</span>
                        <span style="font-size:0.8rem; background:#facc15; color:#000; padding:2px 6px; border-radius:4px;">+${a.c}</span>
                    </div>`;
                }).join('');
            }
        };

        /* GAME LOGIC */
        const Game = {
            grid:[], player:null, nextQ:[], ctx:null, bs:0, hs:0, state:'menu', time:{last:0, drop:0}, lock:false,
            init() {
                UI.init(); Achievements.init();
                this.hs = Storage.get('tetris_hs', 0);
                UI.update(0,1,0,this.hs);
                
                const r = () => { if(this.state!=='menu') { const d=UI.resize(); this.ctx=d.ctx; this.ctx.scale(d.dpr,d.dpr); this.bs=d.bs; this.draw(); }};
                window.addEventListener('resize', r); r();

                UI.modal('start', 0, () => this.start());
                document.getElementById('btn-pause').onclick = (e) => { e.stopPropagation(); this.pause(); };
                
                Input.init(); this.loop = this.loop.bind(this);
            },
            start() {
                this.grid = Array(CONFIG.ROWS).fill().map(()=>Array(CONFIG.COLS).fill(0));
                this.player = { pos:{x:0,y:0}, matrix:null, score:0, level:1, lines:0 };
                this.nextQ = [this.rand(), this.rand()];
                this.state = 'playing';
                Achievements.notify('start'); AudioSys.init();
                
                const d = UI.resize(); this.ctx=d.ctx; this.ctx.scale(d.dpr,d.dpr); this.bs=d.bs;
                
                this.spawn(); UI.update(0,1,0,this.hs);
                this.time.last = performance.now();
                requestAnimationFrame(this.loop);
            },
            spawn() {
                const t = this.nextQ.shift(); this.nextQ.push(this.rand());
                UI.drawNext(CONFIG.SHAPES[this.nextQ[0]], CONFIG.COLORS[this.nextQ[0]]);
                this.player.matrix = CONFIG.SHAPES[t].map(r=>[...r]);
                this.player.pos.x = (CONFIG.COLS/2 | 0) - (this.player.matrix[0].length/2 | 0);
                this.player.pos.y = 0;
                this.lock = true; setTimeout(()=>this.lock=false, 200);

                if(this.collide(this.grid, this.player)) {
                    this.state = 'gameover'; AudioSys.play('over');
                    if(this.player.score > this.hs) { this.hs = this.player.score; Storage.set('tetris_hs', this.hs); }
                    UI.modal('gameover', this.player.score, () => this.start());
                }
            },
            collide(g, p) {
                const [m, o] = [p.matrix, p.pos];
                for(let y=0; y<m.length; ++y) for(let x=0; x<m[y].length; ++x)
                    if(m[y][x]!==0 && (g[y+o.y] && g[y+o.y][x+o.x])!==0) return true;
                return false;
            },
            merge() {
                this.player.matrix.forEach((r,y) => r.forEach((v,x) => { if(v) this.grid[y+this.player.pos.y][x+this.player.pos.x]=v; }));
                AudioSys.play('drop');
            },
            sweep() {
                let c = 0;
                for(let y=CONFIG.ROWS-1; y>=0; --y) {
                    if(this.grid[y].every(v=>v!==0)) {
                        this.grid.splice(y, 1); this.grid.unshift(Array(CONFIG.COLS).fill(0));
                        ++y; c++;
                    }
                }
                if(c>0) {
                    AudioSys.play('clear');
                    const pts=[0,100,300,500,800];
                    this.player.score += pts[c]*this.player.level;
                    this.player.lines += c;
                    this.player.level = Math.floor(this.player.lines/10)+1;
                    
                    Achievements.notify('score', this.player.score);
                    Achievements.notify('lines', this.player.lines);
                    Achievements.notify('level', this.player.level);
                    if(c===4) Achievements.notify('tetris');
                    
                    if(this.player.score > this.hs) this.hs = this.player.score;
                    UI.update(this.player.score, this.player.level, this.player.lines, this.hs);
                    
                    const f = document.getElementById('canvas-container');
                    f.classList.remove('flash'); void f.offsetWidth; f.classList.add('flash');
                }
            },
            drop() {
                if(this.lock) return;
                this.player.pos.y++;
                if(this.collide(this.grid, this.player)) {
                    this.player.pos.y--; this.merge(); this.sweep(); this.spawn();
                }
                this.time.drop = 0;
            },
            move(d) {
                if(this.lock || this.state!=='playing') return;
                this.player.pos.x += d;
                if(this.collide(this.grid, this.player)) this.player.pos.x -= d;
                else AudioSys.play('move');
            },
            rotate() {
                if(this.lock || this.state!=='playing') return;
                const pos = this.player.pos.x; let off = 1;
                this._rot(this.player.matrix);
                while(this.collide(this.grid, this.player)) {
                    this.player.pos.x += off; off = -(off+(off>0?1:-1));
                    if(off > this.player.matrix[0].length) { this._rot(this.player.matrix,-1); this.player.pos.x=pos; return; }
                }
                AudioSys.play('move');
            },
            _rot(m, d=1) { for(let y=0;y<m.length;++y) for(let x=0;x<y;++x) [m[x][y],m[y][x]]=[m[y][x],m[x][y]]; if(d>0) m.forEach(r=>r.reverse()); else m.reverse(); },
            pause() {
                if(this.state==='gameover') return;
                this.state = (this.state==='playing') ? 'paused' : 'playing';
                if(this.state==='paused') UI.modal('pause', 0, () => this.pause());
                else { UI.hideModal(); this.time.last = performance.now(); requestAnimationFrame(this.loop); }
            },
            loop(now=0) {
                const dt = now - this.time.last; this.time.last = now;
                if(this.state==='playing') {
                    this.time.drop += dt;
                    const speed = Math.max(100, 800 - (this.player.level*50));
                    if(this.time.drop > speed) this.drop();
                    this.draw();
                    requestAnimationFrame(this.loop);
                }
            },
            draw() {
                if(!this.ctx) return;
                this.ctx.clearRect(0,0,this.ctx.canvas.width, this.ctx.canvas.height);
                this.drawM(this.grid, {x:0,y:0});
                
                if(this.player.matrix) {
                    let gy = this.player.pos.y;
                    while(!this.collide(this.grid, {pos:{x:this.player.pos.x, y:gy+1}, matrix:this.player.matrix})) gy++;
                    this.ctx.globalAlpha = 0.2; this.drawM(this.player.matrix, {x:this.player.pos.x, y:gy}, true);
                    this.ctx.globalAlpha = 1; this.drawM(this.player.matrix, this.player.pos);
                }
            },
            drawM(m, o, g=false) {
                m.forEach((r,y) => r.forEach((v,x) => {
                    if(v) {
                        const c = g ? '#fff' : CONFIG.COLORS[v];
                        const s = this.bs; const px = (x+o.x)*s; const py = (y+o.y)*s;
                        this.ctx.fillStyle = c; this.ctx.fillRect(px,py,s-1,s-1);
                        if(!g) {
                            this.ctx.fillStyle = 'rgba(255,255,255,0.3)'; this.ctx.fillRect(px,py,s-1,s*0.2);
                            this.ctx.fillStyle = 'rgba(0,0,0,0.2)'; this.ctx.fillRect(px,py+s*0.8,s-1,s*0.2);
                        }
                    }
                }));
            },
            rand() { return (Math.random()*7|0)+1; }
        };

        const Input = {
            mode: 'swipe', tx: 0, ty: 0, lx: 0,
            init() {
                document.addEventListener('keydown', e => {
                    if(e.code==='ArrowLeft') Game.move(-1); else if(e.code==='ArrowRight') Game.move(1);
                    else if(e.code==='ArrowDown') Game.drop(); else if(e.code==='ArrowUp') Game.rotate();
                    else if(e.code==='Escape') Game.pause();
                });

                const z = document.getElementById('touch-layer');
                z.addEventListener('touchstart', e => {
                    if(this.mode!=='swipe' || e.target.closest('button')) return;
                    e.preventDefault();
                    this.tx = e.touches[0].clientX; this.ty = e.touches[0].clientY;
                    AudioSys.init();
                }, {passive:false});

                z.addEventListener('touchmove', e => {
                    if(this.mode!=='swipe') return;
                    e.preventDefault();
                    const dx = e.touches[0].clientX - this.tx;
                    const dy = e.touches[0].clientY - this.ty;
                    if(Math.abs(dx - this.lx) > 25) { Game.move(dx>this.lx?1:-1); this.lx=dx; }
                    if(dy > 60) { Game.drop(); this.ty = e.touches[0].clientY; }
                }, {passive:false});

                z.addEventListener('touchend', e => {
                    if(this.mode!=='swipe') return;
                    const dx = e.changedTouches[0].clientX - this.tx;
                    const dy = e.changedTouches[0].clientY - this.ty;
                    if(Math.abs(dx)<10 && Math.abs(dy)<10) Game.rotate();
                    this.lx = 0;
                });

                this.bind('btn-left', ()=>Game.move(-1));
                this.bind('btn-right', ()=>Game.move(1));
                this.bind('btn-down', ()=>Game.drop());
                const rot = document.getElementById('btn-rotate');
                rot.addEventListener('touchstart', (e)=>{e.preventDefault();Game.rotate();});
                rot.addEventListener('mousedown', (e)=>{e.preventDefault();Game.rotate();});
            },
            bind(id, fn) {
                const b = document.getElementById(id); let t;
                const s = (e) => { e.preventDefault(); fn(); t=setInterval(fn,120); };
                const e = (e) => { e.preventDefault(); clearInterval(t); };
                b.addEventListener('touchstart', s); b.addEventListener('touchend', e);
                b.addEventListener('mousedown', s); b.addEventListener('mouseup', e);
            },
            setMode(m) {
                this.mode = m;
                UI.els['mode-swipe'].classList.toggle('active', m==='swipe');
                UI.els['mode-dpad'].classList.toggle('active', m==='dpad');
                document.getElementById('dpad').classList.toggle('show', m==='dpad');
                document.getElementById('touch-layer').style.pointerEvents = m==='swipe'?'auto':'none';
            }
        };

        window.onload = () => { lucide.createIcons(); Game.init(); };
    </script>
</body>
</html>
